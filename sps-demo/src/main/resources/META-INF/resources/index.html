<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPS Demo Dashboard</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #1a1a2e; color: #eee; min-height: 100vh; }
        .header { background: #16213e; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #0f3460; }
        .header h1 { font-size: 1.5rem; color: #e94560; }
        .status { display: flex; align-items: center; gap: 0.5rem; }
        .status-dot { width: 12px; height: 12px; border-radius: 50%; background: #666; }
        .status-dot.connected { background: #4ade80; animation: pulse 2s infinite; }
        .status-dot.disconnected { background: #ef4444; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .container { display: grid; grid-template-columns: 320px 1fr; gap: 1rem; padding: 1rem; height: calc(100vh - 70px); }
        .sidebar { display: flex; flex-direction: column; gap: 1rem; }
        .card { background: #16213e; border-radius: 8px; padding: 1rem; border: 1px solid #0f3460; }
        .card h2 { font-size: 1rem; color: #e94560; margin-bottom: 1rem; border-bottom: 1px solid #0f3460; padding-bottom: 0.5rem; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.25rem; font-size: 0.85rem; color: #aaa; }
        .form-group input, .form-group textarea { width: 100%; padding: 0.5rem; border: 1px solid #0f3460; border-radius: 4px; background: #1a1a2e; color: #eee; font-family: monospace; }
        .form-group textarea { min-height: 100px; resize: vertical; }
        .btn { padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; transition: all 0.2s; }
        .btn-primary { background: #e94560; color: white; }
        .btn-primary:hover { background: #d63850; }
        .btn-secondary { background: #0f3460; color: #eee; }
        .btn-secondary:hover { background: #1a4a7a; }
        .btn-group { display: flex; gap: 0.5rem; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; }
        .stat { background: #1a1a2e; padding: 0.75rem; border-radius: 4px; text-align: center; }
        .stat-value { font-size: 1.5rem; font-weight: bold; }
        .stat-value.published { color: #60a5fa; }
        .stat-value.received { color: #4ade80; }
        .stat-label { font-size: 0.75rem; color: #888; }
        .events-panel { overflow: hidden; display: flex; flex-direction: column; }
        .events-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .events-list { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 0.5rem; }
        .event-card { background: #1a1a2e; border-radius: 6px; padding: 0.75rem; border-left: 3px solid; }
        .event-card.published { border-color: #60a5fa; }
        .event-card.received { border-color: #4ade80; }
        .event-card.failed { border-color: #ef4444; }
        .event-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .event-direction { font-size: 0.7rem; font-weight: 600; padding: 0.15rem 0.4rem; border-radius: 3px; }
        .event-direction.published { background: #1e3a5f; color: #60a5fa; }
        .event-direction.received { background: #1a3a2e; color: #4ade80; }
        .event-type { font-size: 0.8rem; background: #0f3460; padding: 0.15rem 0.5rem; border-radius: 3px; }
        .event-time { font-size: 0.75rem; color: #666; }
        .event-id { font-size: 0.75rem; color: #888; font-family: monospace; margin-bottom: 0.25rem; }
        .event-payload { font-size: 0.8rem; font-family: monospace; background: #0d0d1a; padding: 0.5rem; border-radius: 4px; white-space: pre-wrap; word-break: break-all; max-height: 150px; overflow-y: auto; }
        .toast { position: fixed; bottom: 1rem; right: 1rem; padding: 0.75rem 1rem; border-radius: 6px; color: white; font-weight: 500; animation: slideIn 0.3s; z-index: 1000; }
        .toast.success { background: #22c55e; }
        .toast.error { background: #ef4444; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .empty-state { text-align: center; padding: 2rem; color: #666; }
    </style>
</head>
<body>
    <header class="header">
        <h1>SPS Demo Dashboard</h1>
        <div class="status">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Connecting...</span>
        </div>
    </header>
    <div class="container">
        <aside class="sidebar">
            <div class="card">
                <h2>Publish Event</h2>
                <form id="publishForm">
                    <div class="form-group">
                        <label for="eventType">Event Type</label>
                        <input type="text" id="eventType" value="demo_event_01" placeholder="e.g., greeting_01">
                    </div>
                    <div class="form-group">
                        <label for="payload">JSON Payload</label>
                        <textarea id="payload" placeholder='{"message": "Hello World!"}'></textarea>
                    </div>
                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary">Publish</button>
                        <button type="reset" class="btn btn-secondary">Clear</button>
                    </div>
                </form>
            </div>
            <div class="card">
                <h2>Statistics</h2>
                <div class="stats-grid">
                    <div class="stat">
                        <div class="stat-value published" id="publishedCount">0</div>
                        <div class="stat-label">Published</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value received" id="receivedCount">0</div>
                        <div class="stat-label">Received</div>
                    </div>
                </div>
                <button class="btn btn-secondary" style="width:100%;margin-top:0.75rem" onclick="resetStats()">Reset Stats</button>
            </div>
        </aside>
        <main class="card events-panel">
            <div class="events-header">
                <h2>Event Stream</h2>
                <button class="btn btn-secondary" onclick="clearEvents()">Clear</button>
            </div>
            <div class="events-list" id="eventsList">
                <div class="empty-state">No events yet. Publish an event to get started!</div>
            </div>
        </main>
    </div>

    <script>
        let eventSource = null;
        let events = [];
        const MAX_EVENTS = 100;

        function connect() {
            if (eventSource) eventSource.close();
            
            eventSource = new EventSource('/demo/events/stream');
            
            eventSource.addEventListener('connected', () => {
                setStatus(true);
                fetchStats();
            });
            
            eventSource.addEventListener('event', (e) => {
                const event = JSON.parse(e.data);
                addEvent(event);
                updateStats(event);
            });
            
            eventSource.onerror = () => {
                setStatus(false);
                setTimeout(connect, 3000);
            };
        }

        function setStatus(connected) {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            dot.className = 'status-dot ' + (connected ? 'connected' : 'disconnected');
            text.textContent = connected ? 'Connected' : 'Disconnected';
        }

        function addEvent(event) {
            events.unshift(event);
            if (events.length > MAX_EVENTS) events.pop();
            renderEvents();
        }

        function renderEvents() {
            const list = document.getElementById('eventsList');
            if (events.length === 0) {
                list.innerHTML = '<div class="empty-state">No events yet. Publish an event to get started!</div>';
                return;
            }
            list.innerHTML = events.map(e => `
                <div class="event-card ${e.direction.toLowerCase()} ${e.status === 'FAILED' ? 'failed' : ''}">
                    <div class="event-header">
                        <span class="event-direction ${e.direction.toLowerCase()}">${e.direction}</span>
                        <span class="event-type">${e.eventType}</span>
                        <span class="event-time">${new Date(e.timestamp).toLocaleTimeString()}</span>
                    </div>
                    <div class="event-id">ID: ${e.eventId}</div>
                    <div class="event-payload">${JSON.stringify(e.payload, null, 2)}</div>
                </div>
            `).join('');
        }

        function clearEvents() {
            events = [];
            renderEvents();
        }

        function updateStats(event) {
            const el = document.getElementById(event.direction === 'PUBLISHED' ? 'publishedCount' : 'receivedCount');
            el.textContent = parseInt(el.textContent) + 1;
        }

        async function fetchStats() {
            try {
                const res = await fetch('/demo/stats');
                const stats = await res.json();
                document.getElementById('publishedCount').textContent = stats.publishedCount;
                document.getElementById('receivedCount').textContent = stats.receivedCount;
            } catch (e) { console.error('Failed to fetch stats', e); }
        }

        async function resetStats() {
            try {
                await fetch('/demo/stats', { method: 'DELETE' });
                document.getElementById('publishedCount').textContent = '0';
                document.getElementById('receivedCount').textContent = '0';
                showToast('Stats reset', 'success');
            } catch (e) { showToast('Failed to reset stats', 'error'); }
        }

        document.getElementById('publishForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const type = document.getElementById('eventType').value || 'demo_event_01';
            const payloadStr = document.getElementById('payload').value || '{}';
            
            let payload;
            try {
                payload = JSON.parse(payloadStr);
            } catch (err) {
                showToast('Invalid JSON payload', 'error');
                return;
            }

            try {
                const res = await fetch(`/demo/publish?type=${encodeURIComponent(type)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (res.ok) {
                    showToast('Event published!', 'success');
                } else {
                    showToast('Publish failed', 'error');
                }
            } catch (err) {
                showToast('Network error', 'error');
            }
        });

        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        connect();
    </script>
</body>
</html>
